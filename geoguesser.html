<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GeoGuesser</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<style>
  :root {
    --color-white: rgba(255, 255, 255, 1);
    --color-black: rgba(0, 0, 0, 1);
    --color-cream-50: rgba(252, 252, 249, 1);
    --color-cream-100: rgba(255, 255, 253, 1);
    --color-gray-300: rgba(167, 169, 169, 1);
    --color-slate-500: rgba(98, 108, 113, 1);
    --color-charcoal-700: rgba(31, 33, 33, 1);
    --color-teal-500: rgba(33, 128, 141, 1);
    --color-teal-600: rgba(29, 116, 128, 1);
    --color-red-500: rgba(192, 21, 47, 1);
  }
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
      Oxygen, Ubuntu, Cantarell, sans-serif;
    background-color: var(--color-cream-50);
    color: var(--color-charcoal-700);
  }
  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 10px 15px;
  }
  header {
    background: linear-gradient(
      135deg,
      var(--color-teal-500),
      var(--color-teal-600)
    );
    color: white;
    padding: 1rem 15px;
    text-align: center;
    font-weight: 700;
    font-size: 1.8rem;
    user-select: none;
  }
  .game-section {
    display: none;
    padding: 10px 0 30px 0;
  }
  .game-section.active {
    display: block;
  }
  .upload-area {
    border: 2px dashed var(--color-gray-300);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    color: var(--color-slate-500);
    margin-bottom: 10px;
  }
  .upload-area.drag-over {
    border-color: var(--color-teal-500);
    background-color: #e5f4f7;
    color: var(--color-teal-600);
  }
  input[type='file'] {
    display: none;
  }
  #uploaded-images {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    max-height: 140px;
    overflow-y: auto;
    border: 1px solid var(--color-gray-300);
    padding: 5px;
    border-radius: 8px;
    margin-bottom: 12px;
  }
  .uploaded-image-item {
    position: relative;
    width: 120px;
    height: 90px;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid var(--color-gray-300);
    flex-shrink: 0;
  }
  .uploaded-image-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .remove-image {
    position: absolute;
    top: 2px;
    right: 2px;
    background-color: var(--color-red-500);
    border: none;
    color: white;
    font-size: 0.8rem;
    padding: 2px 6px;
    border-radius: 3px;
    cursor: pointer;
    opacity: 0.85;
  }
  .remove-image:hover {
    opacity: 1;
  }
  .btn {
    cursor: pointer;
    outline: none;
    border: none;
    padding: 7px 16px;
    font-weight: 700;
    border-radius: 5px;
    min-width: 120px;
    font-size: 1rem;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .btn-primary {
    background-color: var(--color-teal-500);
    color: white;
  }
  .btn-primary:hover:not(:disabled) {
    background-color: var(--color-teal-600);
  }
  .btn-secondary {
    background-color: var(--color-gray-300);
    color: var(--color-charcoal-700);
  }
  .btn-secondary:hover:not(:disabled) {
    background-color: var(--color-gray-400);
  }
  #continue-setup,
  #start-game,
  #submit-guess,
  #next-round,
  #play-again,
  #upload-new {
    margin-right: 15px;
  }
  #csv-upload-label {
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--color-teal-500);
  }
  #csv-file-input {
    display: none;
  }
  #setup-and-game-container {
    display: flex;
    gap: 15px;
    justify-content: space-between;
    margin-top: 8px;
  }
  #setup-images,
  #setup-map,
  #game-map {
    border: 2px solid var(--color-gray-300);
    border-radius: 8px;
    box-sizing: border-box;
  }
  #setup-images,
  #game-image-container {
    flex: 1 1 320px;
    max-width: 400px;
    overflow-y: auto;
    max-height: 320px;
  }
  #setup-images {
    padding-right: 5px;
  }
  #setup-map,
  #game-map {
    flex: 2 1 620px;
    min-height: 320px;
  }
  .setup-image-item {
    margin-bottom: 10px;
    display: flex;
    gap: 10px;
    align-items: center;
    border-bottom: 1px solid var(--color-gray-300);
    padding-bottom: 8px;
  }
  .setup-image-item img {
    height: 70px;
    object-fit: cover;
    border-radius: 6px;
    width: 100px;
  }
  .location-input {
    flex-grow: 1;
    font-size: 0.9rem;
    padding: 6px 8px;
    border-radius: 5px;
    border: 1px solid var(--color-gray-300);
  }
  .location-input:focus {
    border-color: var(--color-teal-500);
    outline: none;
  }
  .coordinates-display {
    font-size: 0.8rem;
    color: var(--color-slate-500);
    margin-top: 3px;
  }
  #game-image-container {
    text-align: center;
  }
  #current-image {
    max-width: 100%;
    max-height: 320px;
    border-radius: 8px;
    border: 2px solid var(--color-gray-300);
    object-fit: contain;
  }
  #round-info {
    font-weight: 700;
    font-size: 1.2rem;
    margin-bottom: 10px;
    text-align: center;
  }
  #timer {
    text-align: center;
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-teal-600);
    margin-bottom: 10px;
  }
  #game-status {
    margin-top: 8px;
    font-weight: 600;
    color: var(--color-teal-500);
    font-size: 0.95rem;
  }
  #round-result {
    margin-top: 14px;
    border: 2px solid var(--color-gray-300);
    border-radius: 10px;
    background-color: var(--color-cream-100);
    padding: 10px 15px;
  }
  #round-result h3 {
    font-weight: 700;
    margin-bottom: 8px;
    font-size: 1.1rem;
  }
  .result-details {
    display: flex;
    justify-content: space-around;
    gap: 10px;
    flex-wrap: wrap;
  }
  .result-item {
    min-width: 80px;
    padding: 5px 10px;
    text-align: center;
  }
  .result-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: var(--color-slate-500);
  }
  .result-value {
    font-weight: 700;
    font-size: 1rem;
  }
  #results-section {
    text-align: center;
  }
  #final-score {
    font-size: 2.2rem;
    color: var(--color-teal-500);
    font-weight: 700;
    margin-bottom: 4px;
  }
  #final-percentage {
    font-size: 1.1rem;
    margin-bottom: 18px;
    color: var(--color-slate-500);
  }
  #results-list {
    max-height: 220px;
    overflow-y: auto;
    border: 1px solid var(--color-gray-300);
    border-radius: 8px;
    padding: 6px;
  }
  .round-summary {
    display: flex;
    justify-content: space-between;
    font-weight: 600;
    padding: 4px 6px;
    border-bottom: 1px solid var(--color-gray-300);
  }
  .round-summary:last-child {
    border-bottom: none;
  }
  #csv-info {
    font-size: 0.85rem;
    color: var(--color-slate-500);
    margin-bottom: 5px;
    text-align: center;
  }
</style>
</head>
<body>
<header>GeoGuesser</header>
<main class="container">
  <!-- Upload Section -->
  <section id="upload-section" class="game-section active">
    <div class="upload-area" id="upload-area" tabindex="0" aria-label="Upload images by drag or click">
      <div>Drag and drop images here or click to select (Accepts JPG, PNG, JPEG)</div>
      <input type="file" id="file-input" multiple accept="image/jpeg,image/jpg,image/png" />
    </div>
    <div id="uploaded-images" aria-label="Uploaded images container"></div>
    <label for="csv-file-input" id="csv-upload-label" tabindex="0">Or upload CSV file with locations</label>
    <input type="file" id="csv-file-input" accept=".csv,text/csv" />
    <div id="csv-info"></div>
    <div style="margin-top: 10px; text-align:center;">
      <button id="continue-setup" class="btn btn-primary" disabled>Continue to Setup</button>
      <button id="try-demo" class="btn btn-secondary">Try Demo Mode</button>
    </div>
  </section>

  <!-- Setup & Game Compact Container -->
  <section id="setup-section" class="game-section">
    <div id="setup-and-game-container">
      <div id="setup-images" aria-label="Setup image list"></div>
      <div id="setup-map" style="height:320px;"></div>
    </div>
    <div style="text-align:center; margin-top:15px;">
      <button id="back-to-upload" class="btn btn-secondary">Back to Upload</button>
      <button id="start-game" class="btn btn-primary" disabled>Start Game</button>
    </div>
  </section>

  <!-- Game Section -->
  <section id="game-section" class="game-section">
    <div id="round-info" aria-live="polite" ></div>
    <div id="game-map" style="height: 320px; border: 2px solid #a7a9ac; border-radius: 8px;"></div>
    <div id="game-image-container" style="margin-top:12px; text-align:center;">
      <img id="current-image" alt="Location to guess" />
      <div id="game-status" role="status" aria-live="polite"></div>
    </div>
    <div style="text-align:center; margin-top:8px;">
      <button id="submit-guess" class="btn btn-primary" disabled>Submit Guess</button>
      <button id="next-round" class="btn btn-primary" style="display:none;">Next Round</button>
    </div>
    <div id="round-result" style="margin-top:15px; display:none;">
      <h3 style="margin-bottom:6px;">Round Result</h3>
      <div class="result-details">
        <div class="result-item">
          <div class="result-label">Your Guess</div>
          <div class="result-value" id="guess-location">-</div>
        </div>
        <div class="result-item">
          <div class="result-label">Actual Location</div>
          <div class="result-value" id="actual-location">-</div>
        </div>
        <div class="result-item">
          <div class="result-label">Distance</div>
          <div class="result-value" id="round-distance">0 km</div>
        </div>
        <div class="result-item">
          <div class="result-label">Points</div>
          <div class="result-value" id="round-points">0</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Results Section -->
  <section id="results-section" class="game-section">
    <div id="final-score" aria-live="polite"></div>
    <div id="final-percentage"></div>
    <div id="results-list" aria-label="Round results breakdown" tabindex="0"></div>
    <div style="text-align:center; margin-top:15px;">
      <button id="play-again" class="btn btn-primary">Play Again</button>
      <button id="upload-new" class="btn btn-secondary">Upload New Images</button>
    </div>
  </section>
</main>

<!-- EXIF.js library -->
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  class GeoGuesser {
    constructor() {
      this.images = [];
      this.locationsFromCSV = {};
      this.currentRound = 0;
      this.score = 0;
      this.roundResults = [];
      this.gameState = {
        currentGuess: null,
        roundInProgress: false,
        showingResults: false,
        processing: false,
      };
      this.demoMode = false;

      // Settings
      this.settings = {
        maxImages: 10,
        maxScore: 5000,
        perfectDistance: 25,
        goodDistance: 100,
        okDistance: 500,
        farDistance: 1500,
      };

      // Map config
      this.mapConfig = {
        center: [20, 0],
        zoom: 2,
        tileLayer: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        attribution: "© OpenStreetMap contributors",
      };

      this.setupMap = null;
      this.gameMap = null;
      this.currentMarkers = [];

      // Bind UI Elements
      this.bindUI();

      this.showSection("upload-section");
    }

    bindUI() {
      this.fileInput = document.getElementById("file-input");
      this.uploadArea = document.getElementById("upload-area");
      this.uploadImagesContainer = document.getElementById("uploaded-images");
      this.continueSetupBtn = document.getElementById("continue-setup");
      this.tryDemoBtn = document.getElementById("try-demo");
      this.csvFileInput = document.getElementById("csv-file-input");
      this.csvInfo = document.getElementById("csv-info");

      this.setupImagesContainer = document.getElementById("setup-images");
      this.startGameBtn = document.getElementById("start-game");
      this.backToUploadBtn = document.getElementById("back-to-upload");
      this.setupMapContainer = document.getElementById("setup-map");

      this.roundInfo = document.getElementById("round-info");
      this.gameStatus = document.getElementById("game-status");
      this.currentImage = document.getElementById("current-image");
      this.gameMapContainer = document.getElementById("game-map");
      this.submitGuessBtn = document.getElementById("submit-guess");
      this.nextRoundBtn = document.getElementById("next-round");

      this.roundResult = document.getElementById("round-result");
      this.guessLocation = document.getElementById("guess-location");
      this.actualLocation = document.getElementById("actual-location");
      this.roundDistance = document.getElementById("round-distance");
      this.roundPoints = document.getElementById("round-points");

      this.resultsSection = document.getElementById("results-section");
      this.finalScore = document.getElementById("final-score");
      this.finalPercentage = document.getElementById("final-percentage");
      this.resultsList = document.getElementById("results-list");
      this.playAgainBtn = document.getElementById("play-again");
      this.uploadNewBtn = document.getElementById("upload-new");

      this.continueSetupBtn.disabled = true;

      // Event listeners
      // Upload area click/focus/drag-drop
      this.uploadArea.addEventListener("click", () => this.fileInput.click());
      this.uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        this.uploadArea.classList.add("drag-over");
      });
      this.uploadArea.addEventListener("dragleave", () => {
        this.uploadArea.classList.remove("drag-over");
      });
      this.uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        this.uploadArea.classList.remove("drag-over");
        this.handleFiles(e.dataTransfer.files);
      });
      this.fileInput.addEventListener("change", (e) =>
        this.handleFiles(e.target.files)
      );

      this.csvFileInput.addEventListener("change", (e) =>
        this.processCSVFile(e.target.files)
      );

      this.continueSetupBtn.addEventListener("click", () => this.showSetup());
      this.tryDemoBtn.addEventListener("click", () => this.startDemo());
      this.backToUploadBtn.addEventListener("click", () => this.showSection("upload-section"));
      this.startGameBtn.addEventListener("click", () => this.startGame());

      this.submitGuessBtn.addEventListener("click", () => this.submitGuess());
      this.nextRoundBtn.addEventListener("click", () => this.nextRound());

      this.playAgainBtn.addEventListener("click", () => {
        this.resetGame();
        this.startGame();
      });
      this.uploadNewBtn.addEventListener("click", () => {
        this.resetGame();
        this.showSection("upload-section");
      });
    }

    showSection(id) {
      document.querySelectorAll(".game-section").forEach((el) => {
        el.classList.remove("active");
      });
      const sec = document.getElementById(id);
      if (sec) sec.classList.add("active");
    }

    handleFiles(fileList) {
      const files = Array.from(fileList).slice(0, this.settings.maxImages - this.images.length);
      if (!files.length) return;

      this.csvInfo.textContent = "";
      let pendingExif = 0;
      files.forEach((file) => {
        if (!file.type.startsWith("image")) return;
        pendingExif++;
        const reader = new FileReader();
        reader.onload = (evt) => {
          const dataURL = evt.target.result;
          // Create image record with basic info
          const imageObj = {
            id: Date.now() + Math.random(),
            fileName: file.name,
            size: this.formatFileSize(file.size),
            thumbnail: dataURL,
            originalSrc: dataURL,
            location: null,
            coordinates: null,
            exifChecked: false,
          };
          this.images.push(imageObj);
          this.extractExifCoordinates(file, imageObj, () => {
            pendingExif--;
            if (pendingExif === 0) {
              this.displayUploadedImages();
              this.updateContinueButton();
              if (this.csvFileInput.files.length > 0) {
                this.matchCSVLocations();
              }
            }
          });
        };
        reader.readAsDataURL(file);
      });

      this.continueSetupBtn.disabled = true;
    }

    extractExifCoordinates(file, imageObj, callback) {
      try {
        EXIF.getData(file, function () {
          const lat = EXIF.getTag(this, "GPSLatitude");
          const lon = EXIF.getTag(this, "GPSLongitude");
          const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
          const lonRef = EXIF.getTag(this, "GPSLongitudeRef") || "E";

          if (lat && lon) {
            imageObj.coordinates = {
              lat: convertDMSToDD(lat, latRef),
              lng: convertDMSToDD(lon, lonRef),
            };
          }
          imageObj.exifChecked = true;
          callback();
        });
      } catch (e) {
        imageObj.exifChecked = true;
        callback();
      }

      function convertDMSToDD(dms, ref) {
        const [deg, min, sec] = dms;
        let dd = deg + min / 60 + sec / 3600;
        if (ref === "S" || ref === "W") dd = dd * -1;
        return dd;
      }
    }

    displayUploadedImages() {
      this.uploadImagesContainer.innerHTML = "";
      this.images.forEach((img) => {
        const div = document.createElement("div");
        div.className = "uploaded-image-item";
        div.title = img.fileName;
        div.innerHTML = `
          <img src="${img.thumbnail}" alt="Thumbnail of ${img.fileName}" />
          <button class="remove-image" aria-label="Remove ${img.fileName}" data-id="${img.id}">&times;</button>
          `;
        div.querySelector(".remove-image").onclick = () => {
          this.images = this.images.filter((i) => i.id !== img.id);
          this.displayUploadedImages();
          this.updateContinueButton();
        };
        this.uploadImagesContainer.appendChild(div);
      });
    }

    updateContinueButton() {
      this.continueSetupBtn.disabled = this.images.length === 0;
    }

    processCSVFile(files) {
      if (!files.length) {
        this.csvInfo.textContent = "";
        this.locationsFromCSV = {};
        return;
      }
      const file = files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        this.parseCSV(text);
      };
      reader.readAsText(file);
    }

    parseCSV(csvText) {
      // Expecting CSV: filename,lat,lng,location(optional)
      this.locationsFromCSV = {};
      let lines = csvText.trim().split("\n");

      lines.forEach((line, index) => {
        if (!line.trim()) return;
        const parts = line.split(",");
        if (parts.length < 3) return;
        const filename = parts[0].trim();
        const lat = parseFloat(parts[1]);
        const lng = parseFloat(parts[2]);
        const loc = parts[3]?.trim() || "";
        if (
          filename &&
          !isNaN(lat) &&
          !isNaN(lng) &&
          lat >= -90 &&
          lat <= 90 &&
          lng >= -180 &&
          lng <= 180
        ) {
          this.locationsFromCSV[filename.toLowerCase()] = {
            lat,
            lng,
            location: loc,
          };
        }
      });

      this.csvInfo.textContent =
        "CSV loaded: Found " +
        Object.keys(this.locationsFromCSV).length +
        " location entries.";
      this.matchCSVLocations();
    }

    matchCSVLocations() {
      if (!this.locationsFromCSV) return;
      let updatedCount = 0;
      this.images.forEach((img) => {
        if (img.coordinates) return; // Keeps EXIF coords
        const locData =
          this.locationsFromCSV[img.fileName.toLowerCase()] ||
          this.locationsFromCSV[img.fileName.toLowerCase().replace(/\s/g, "")];
        if (locData) {
          img.coordinates = { lat: locData.lat, lng: locData.lng };
          if (locData.location) img.location = locData.location;
          updatedCount++;
        }
      });

      // Update display if we're still in upload phase
      if (document.getElementById("upload-section").classList.contains("active")) {
        this.displayUploadedImages();
        this.updateContinueButton();
      }
    }

    showSetup() {
      this.showSection("setup-section");
      this.renderSetupImages();
      this.initSetupMap();
    }

    renderSetupImages() {
      this.setupImagesContainer.innerHTML = "";
      this.images.forEach((img) => {
        const div = document.createElement("div");
        div.className = "setup-image-item";

        div.innerHTML = `
          <img src="${img.thumbnail}" alt="Setup thumbnail ${img.fileName}" />
          <input type="text" data-id="${img.id}" value="${img.location || ""}" placeholder="Optional description" class="location-input" />
          <div class="coordinates-display" id="coords-${img.id}">${
          img.coordinates
            ? `Lat: ${img.coordinates.lat.toFixed(4)}, Lng: ${img.coordinates.lng.toFixed(4)}`
            : "Click map to set"
        }</div>
        `;
        const input = div.querySelector(".location-input");
        input.addEventListener("input", (e) => {
          const toEdit = this.images.find((i) => i.id === img.id);
          if (toEdit) toEdit.location = e.target.value;
        });
        this.setupImagesContainer.appendChild(div);
      });

      document
        .getElementById("start-game")
        .setAttribute("disabled", "disabled"); // Disable initially until all set

      this.checkAllLocations();
    }

    checkAllLocations() {
      const allSet = this.images.every((img) => img.coordinates != null);
      this.startGameBtn.disabled = !allSet || this.images.length === 0;
    }

    initSetupMap() {
      if (this.setupMap) {
        this.setupMap.off();
        this.setupMap.remove();
      }
      this.setupMap = L.map("setup-map").setView(
        this.mapConfig.center,
        this.mapConfig.zoom
      );
      L.tileLayer(this.mapConfig.tileLayer, {
        attribution: this.mapConfig.attribution,
        maxZoom: 18,
        minZoom: 1,
      }).addTo(this.setupMap);

      this.setupMap.on("click", (e) => this.onSetupMapClick(e));

      // Add markers on existing locations
      this.images.forEach((img) => {
        if (img.coordinates) {
          img._marker = L.marker([img.coordinates.lat, img.coordinates.lng], {
            draggable: true,
          })
            .addTo(this.setupMap)
            .bindPopup(img.fileName);

          img._marker.on("dragend", (event) => {
            const marker = event.target;
            const pos = marker.getLatLng();
            img.coordinates = { lat: pos.lat, lng: pos.lng };
            const coordsDisp = document.getElementById(`coords-${img.id}`);
            if (coordsDisp) {
              coordsDisp.textContent = `Lat: ${pos.lat.toFixed(
                4
              )}, Lng: ${pos.lng.toFixed(4)}`;
            }
            this.checkAllLocations();
          });
        }
      });

      this.checkAllLocations();
    }

    onSetupMapClick(e) {
      const imgWithoutCoords = this.images.find((img) => !img.coordinates);
      if (!imgWithoutCoords) return;

      imgWithoutCoords.coordinates = { lat: e.latlng.lat, lng: e.latlng.lng };
      const coordsDisp = document.getElementById(`coords-${imgWithoutCoords.id}`);
      if (coordsDisp) {
        coordsDisp.textContent = `Lat: ${e.latlng.lat.toFixed(
          4
        )}, Lng: ${e.latlng.lng.toFixed(4)}`;
      }

      if (imgWithoutCoords._marker) {
        this.setupMap.removeLayer(imgWithoutCoords._marker);
      }
      imgWithoutCoords._marker = L.marker([e.latlng.lat, e.latlng.lng], {
        draggable: true,
      })
        .addTo(this.setupMap)
        .bindPopup(imgWithoutCoords.fileName);

      imgWithoutCoords._marker.on("dragend", (event) => {
        const marker = event.target;
        const pos = marker.getLatLng();
        imgWithoutCoords.coordinates = { lat: pos.lat, lng: pos.lng };
        if (coordsDisp) {
          coordsDisp.textContent = `Lat: ${pos.lat.toFixed(
            4
          )}, Lng: ${pos.lng.toFixed(4)}`;
        }
        this.checkAllLocations();
      });

      this.checkAllLocations();
    }

    startGame() {
      this.gameImages = [...this.images];
      this.currentRound = 0;
      this.score = 0;
      this.roundResults = [];

      this.showSection("game-section");
      this.initGameMap();
      this.loadCurrentRound();
    }

    initGameMap() {
      if (this.gameMap) {
        this.gameMap.off();
        this.gameMap.remove();
      }
      this.gameMap = L.map("game-map").setView(this.mapConfig.center, this.mapConfig.zoom);
      L.tileLayer(this.mapConfig.tileLayer, {
        attribution: this.mapConfig.attribution,
        maxZoom: 18,
        minZoom: 1,
      }).addTo(this.gameMap);

      this.gameMap.on("click", (e) => this.onGameMapClick(e));
      this.currentMarkers = [];
      this.gameState.currentGuess = null;
      this.submitGuessBtn.disabled = true;
      this.nextRoundBtn.style.display = "none";
      this.roundResult.style.display = "none";
      this.gameStatus.textContent = "Click on the map to place your guess";
    }

    loadCurrentRound() {
      if (this.currentRound >= this.gameImages.length) {
        this.showResults();
        return;
      }
      const img = this.gameImages[this.currentRound];
      this.roundInfo.textContent = `Round ${this.currentRound + 1} of ${
        this.gameImages.length
      }`;
      this.currentImage.src = img.originalSrc;
      this.gameState.currentGuess = null;
      this.submitGuessBtn.disabled = true;
      this.nextRoundBtn.style.display = "none";
      this.roundResult.style.display = "none";

      this.currentMarkers.forEach((m) => this.gameMap.removeLayer(m));
      this.currentMarkers = [];
      this.gameStatus.textContent = "Click on the map to place your guess";
    }

    onGameMapClick(e) {
      if (this.gameState.showingResults || this.gameState.processing) return;

      this.gameState.currentGuess = { lat: e.latlng.lat, lng: e.latlng.lng };

      this.currentMarkers.forEach((m) => this.gameMap.removeLayer(m));
      this.currentMarkers = [];

      const guessMarker = L.marker([e.latlng.lat, e.latlng.lng])
        .addTo(this.gameMap)
        .bindPopup("Your Guess")
        .openPopup();
      this.currentMarkers.push(guessMarker);

      this.submitGuessBtn.disabled = false;
      this.gameStatus.textContent = "Guess placed. Submit your guess!";
    }

    submitGuess() {
      if (!this.gameState.currentGuess || this.gameState.processing) return;
      this.gameState.processing = true;
      this.submitGuessBtn.disabled = true;
      this.gameStatus.textContent = "Processing your guess...";
      const currentImage = this.gameImages[this.currentRound];
      const distance = this.calcDistance(
        this.gameState.currentGuess,
        currentImage.coordinates
      );
      const points = this.calcPoints(distance);

      const correctMarker = L.marker([
        currentImage.coordinates.lat,
        currentImage.coordinates.lng,
      ])
        .addTo(this.gameMap)
        .bindPopup(`Correct: ${currentImage.location || "Unknown Location"}`)
        .openPopup();

      this.currentMarkers.push(correctMarker);

      const line = L.polyline(
        [
          [this.gameState.currentGuess.lat, this.gameState.currentGuess.lng],
          [currentImage.coordinates.lat, currentImage.coordinates.lng],
        ],
        { color: "red" }
      ).addTo(this.gameMap);

      this.currentMarkers.push(line);

      this.score += points;

      this.roundResults.push({
        round: this.currentRound + 1,
        image: currentImage,
        guess: this.gameState.currentGuess,
        distance: distance,
        points: points,
      });

      this.showRoundResult(distance, points, currentImage);

      this.gameState.showingResults = true;
      this.gameState.processing = false;
      this.nextRoundBtn.style.display = "inline-block";
      this.gameStatus.textContent = "Round complete! Click next round.";
    }

    showRoundResult(distance, points, image) {
      this.guessLocation.textContent = `${this.gameState.currentGuess.lat.toFixed(
        4
      )}, ${this.gameState.currentGuess.lng.toFixed(4)}`;
      this.actualLocation.textContent = image.location || "Unknown Location";
      this.roundDistance.textContent = `${Math.round(distance)} km`;
      this.roundPoints.textContent = points;

      this.roundResult.style.display = "block";
    }

    nextRound() {
      this.currentRound++;
      this.gameState.currentGuess = null;
      this.gameState.showingResults = false;
      this.submitGuessBtn.disabled = true;
      this.nextRoundBtn.style.display = "none";
      this.roundResult.style.display = "none";

      if (this.currentRound >= this.gameImages.length) {
        this.showResults();
      } else {
        this.loadCurrentRound();
      }
    }

    showResults() {
      this.showSection("results-section");
      const maxScore = this.gameImages.length * this.settings.maxScore;
      this.finalScore.textContent = `${this.score} / ${maxScore}`;
      const pct = Math.round((this.score / maxScore) * 100);
      this.finalPercentage.textContent = `${pct}% Accuracy`;

      this.resultsList.innerHTML = "";
      this.roundResults.forEach((res) => {
        const div = document.createElement("div");
        div.className = "round-summary";
        div.textContent = `Round ${res.round}: ${res.image.fileName} - ${Math.round(
          res.distance
        )} km, ${res.points} points`;
        this.resultsList.appendChild(div);
      });
    }

    resetGame() {
      this.images = [];
      this.locationsFromCSV = {};
      this.currentRound = 0;
      this.score = 0;
      this.roundResults = [];
      this.gameState = {
        currentGuess: null,
        roundInProgress: false,
        showingResults: false,
        processing: false,
      };

      this.fileInput.value = "";
      this.csvFileInput.value = "";
      this.csvInfo.textContent = "";
      this.uploadImagesContainer.innerHTML = "";
      this.setupImagesContainer.innerHTML = "";
      if (this.setupMap) {
        this.setupMap.off();
        this.setupMap.remove();
        this.setupMap = null;
      }
      if (this.gameMap) {
        this.gameMap.off();
        this.gameMap.remove();
        this.gameMap = null;
      }
      this.showSection("upload-section");
    }

    formatFileSize(bytes) {
      if (bytes === 0) return "0 Bytes";
      const k = 1024,
        sizes = ["Bytes", "KB", "MB"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
    }

    calcDistance(coord1, coord2) {
      const R = 6371; // km
      const dLat = this.toRad(coord2.lat - coord1.lat);
      const dLng = this.toRad(coord2.lng - coord1.lng);
      const lat1 = this.toRad(coord1.lat);
      const lat2 = this.toRad(coord2.lat);

      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.sin(dLng / 2) *
          Math.sin(dLng / 2) *
          Math.cos(lat1) *
          Math.cos(lat2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    toRad(val) {
      return (val * Math.PI) / 180;
    }

    calcPoints(distance) {
      if (distance <= this.settings.perfectDistance) {
        return this.settings.maxScore;
      } else if (distance <= this.settings.goodDistance) {
        return Math.round(this.settings.maxScore * 0.8);
      } else if (distance <= this.settings.okDistance) {
        return Math.round(this.settings.maxScore * 0.5);
      } else if (distance <= this.settings.farDistance) {
        return Math.round(this.settings.maxScore * 0.2);
      } else {
        return 0;
      }
    }

    startDemo() {
      this.images = [
        {
          id: "demo1",
          fileName: "EiffelTower.jpg",
          size: "Demo",
          thumbnail:
            "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a8/Tour_Eiffel_Wikimedia_Commons.jpg/320px-Tour_Eiffel_Wikimedia_Commons.jpg",
          originalSrc:
            "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a8/Tour_Eiffel_Wikimedia_Commons.jpg/640px-Tour_Eiffel_Wikimedia_Commons.jpg",
          coordinates: { lat: 48.8584, lng: 2.2945 },
          location: "Eiffel Tower, Paris, France",
        },
        {
          id: "demo2",
          fileName: "TimesSquare.jpg",
          size: "Demo",
          thumbnail:
            "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a1/Times_Square%2C_New_York_City_%28HDR%29.jpg/320px-Times_Square%2C_New_York_City_%28HDR%29.jpg",
          originalSrc:
            "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a1/Times_Square%2C_New_York_City_%28HDR%29.jpg/640px-Times_Square%2C_New_York_City_%28HDR%29.jpg",
          coordinates: { lat: 40.7589, lng: -73.9851 },
          location: "Times Square, New York, USA",
        },
        {
          id: "demo3",
          fileName: "SydneyOperaHouse.jpg",
          size: "Demo",
          thumbnail:
            "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c6/Sydney_Opera_House_-_Dec_2008.jpg/320px-Sydney_Opera_House_-_Dec_2008.jpg",
          originalSrc:
            "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c6/Sydney_Opera_House_-_Dec_2008.jpg/640px-Sydney_Opera_House_-_Dec_2008.jpg",
          coordinates: { lat: -33.8568, lng: 151.2153 },
          location: "Sydney Opera House, Sydney, Australia",
        },
      ];
      this.continueSetupBtn.disabled = false;
      this.showSetup();
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    new GeoGuesser();
  });
</script>
</body>
</html>
